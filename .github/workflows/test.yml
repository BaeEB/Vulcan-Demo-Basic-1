name: regression test

on:
    # push:
    workflow_dispatch:
            
jobs:
    checkout:
        runs-on: self-hosted
        steps:
            - name: checkout source code
              uses: actions/checkout@v2
    build:
        needs: checkout
        runs-on: self-hosted
        steps:
            - name: run build
              run: |
                    rm -rf build
                    cmake -B build . -DBUILD_SHARED_LIBS=OFF -DCMAKE_C_FLAGS="-fsanitize=address"
                    cd build; make -j10

    test:
        needs: build
        runs-on: self-hosted
        steps:
            - name: run test
              run: |
                    python3 test/spec_tests.py -s test/spec.txt -p "build/md2html/md2html"
                    python3 test/spec_tests.py -s test/coverage.txt -p "build/md2html/md2html" --skip 16
                    python3 test/spec_tests.py -s test/permissive-email-autolinks.txt -p "build/md2html/md2html --fpermissive-email-autolinks"
                    python3 test/spec_tests.py -s test/permissive-url-autolinks.txt -p "build/md2html/md2html --fpermissive-url-autolinks"
                    python3 test/spec_tests.py -s test/permissive-www-autolinks.txt -p "build/md2html/md2html --fpermissive-www-autolinks"
                    python3 test/spec_tests.py -s test/tables.txt -p "build/md2html/md2html --ftables"
                    python3 test/spec_tests.py -s test/strikethrough.txt -p "build/md2html/md2html --fstrikethrough"
                    python3 test/spec_tests.py -s test/tasklists.txt -p "build/md2html/md2html --ftasklists"
                    python3 test/pathological_tests.py -p "build/md2html/md2html"
                    python3 test/spec_tests.py -s test/coverage.txt -p "build/md2html/md2html" --number 16