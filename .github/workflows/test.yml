name: regression test

on:
    # push:
    workflow_dispatch:
            
jobs:
    checkout:
        runs-on: self-hosted
        steps:
            - name: checkout source code
              uses: actions/checkout@v2
    build:
        needs: checkout
        runs-on: self-hosted
        steps:
            - name: run build
              run: |
                    ./autogen.sh
                    ./configure --prefix="/home/workspace/install"
                    make -j10
                    make install

    test:
        needs: build
        runs-on: self-hosted
        steps:
            - name: run test
              run: |
                    index=1; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=3; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=4; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=5; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=6; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=7; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=8; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=9; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=10; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=101; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=102; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=103; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=104; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=222; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                
                    index=105; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=106; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=107; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=108; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=109; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
                    index=110; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w tests/result/$(sed -n ${index}p .dpp/test_list) -v 2; example/ndpiReader -p example/protos.txt -c example/categories.txt -q -t -i tests/pcap/$(sed -n ${index}p .dpp/test_list) -w /tmp/reader.out -v 2; diff tests/result/$(sed -n ${index}p .dpp/test_list).out /tmp/reader.out; [ $? -eq 0 ]
